rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - any authenticated user can read, only owner can write
    // Added field validation for security
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId &&
        // Validate required fields and limits
        request.resource.data.keys().hasAll(['fullName', 'email']) &&
        request.resource.data.fullName is string &&
        request.resource.data.fullName.size() <= 100 &&
        request.resource.data.email is string &&
        request.resource.data.email.size() <= 255 &&
        // Skills limit validation (if present)
        (!('skills' in request.resource.data) || 
          (request.resource.data.skills is list && request.resource.data.skills.size() <= 20)) &&
        (!('softSkills' in request.resource.data) || 
          (request.resource.data.softSkills is list && request.resource.data.softSkills.size() <= 20));
    }
    
    // Teams collection - authenticated users can read and write
    // Field names match the actual data structure used in code
    match /teams/{teamId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        // Validate team fields on creation - using actual field names from code
        request.resource.data.teamName is string &&
        request.resource.data.teamName.size() >= 2 &&
        request.resource.data.teamName.size() <= 100 &&
        request.resource.data.createdBy == request.auth.uid;
      // Allow update if:
      // 1. User is the team creator (full control), OR
      // 2. User is adding themselves to the members array (accepting invite)
      allow update: if request.auth != null && (
        resource.data.createdBy == request.auth.uid ||
        (
          // Only allowing members array to be modified (user adding themselves)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']) &&
          request.auth.uid in request.resource.data.members
        )
      );
      // Only creator can delete
      allow delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }
    
    // Events collection - authenticated users can read, creator can write
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }
    
    // Notifications collection
    // - Users can read notifications sent TO them
    // - Any authenticated user can create a notification
    // - Only the recipient can update/delete their notifications
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.toUserId == request.auth.uid;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.toUserId == request.auth.uid;
    }
  }
}
